---
title: "Markdown Template"
output:
  html_document:
    df_print: paged
    theme: cerulean
    highlight: haddock
    toc: yes
    toc_float: yes
    code_folding: show
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=F, warning=F, fig.width = 10)
```


# Load Packages

```{r}

library( haven )
library( tidyr )
library( dplyr )
library( ggplot2 )
library( ggthemes )
library( scales )
library( stargazer )
library( pander )

```

## Custom Functions

```{r}

jplot <- function( x1, x2, lab1="", lab2="", draw.line=T, ... )
{

	plot( x1, x2,
	      pch=19, 
	      col=gray(0.6, alpha = 0.5), 
	      cex=1.5,  
	      bty = "n",
	      xlab=lab1, 
	      ylab=lab2, cex.lab=1.5,
        ... )

	if( draw.line==T ){ 
		ok <- is.finite(x1) & is.finite(x2)
		lines( lowess(x2[ok]~x1[ok]), col="red", lwd=3 ) }

}

```



# Density

## Definitions

Nonprofit density is the measure of the growth and competition in a market. The growth and competition might influence the performance, survival of nonprofits in the market. There are two competing forces generated by density: legitimacy that attracts financial support for nonprofits and competition that creates entry barrier for new organizations (Hannan & Freeman, 1987) 

## Calculations

Nonprofit density be calculated as follows: 

Approach 1:

The number of nonprofits in a market (Harrison & Thornton, 2014; Saxton & Benson, 2005; LeRoux & Wright, 2010; Lecy & Van Slyke, 2013; Castaneda, Garen, & Thornton, 2007 ). 

Approach 2:

The number of nonprofits per capita in a market (Harrison & Thornton, 2014; Paarlberg & Hwang, 2017). This is also called demand density (Harrison & Thornton, 2014).
¡E	measured as the number of organizations per 10,000 population (Paarlberg & Hwang, 2017)
¡E	measured as the number of organizations per 1,000 population (Paarlberg, An, Nesbit, Christensen, & Bullock, 2018)

 
## Notes

We define a market as a Metropolitan Statistical Area (MSA) in which relevant nonprofits compete for resources to survive. 




# Create Pop Table by MSA


```{r, eval=F}

# setwd( "C:/Users/JK/Desktop/R Practice " )
# core.2010 <- readRDS( "nccs.core2010pc.rds" )

core.2010 <- readRDS(gzcon(url("https://www.dropbox.com/s/byt7kh3kejg4ycl/nccs.core2010pc.rds?dl=1")))

pop <- read.csv( "https://www.dropbox.com/s/k0b8o17k03ffio0/MSA.Population.2010.csv?dl=1", stringsAsFactors=F )

pop2 <- select( pop, POPU, FIPS ) %>% unique()
pop3 <- na.omit(pop2)

pop3 <- rename( pop3, MSA_POP=POPU )

names( core.2010 ) <- toupper( names( core.2010 ))

core <- select( core.2010, EIN, MSA_NECH, NTMAJ12, FIPS)
core$FIPS <- as.numeric( core$FIPS )

core1 <- merge( core, pop3, by.x="FIPS", by.y="FIPS", all.x=T )


new.pop.table <- unique( select( core1, MSA_NECH, MSA_POP ))
new.pop.table <- na.omit( new.pop.table )
nrow( new.pop.table )
write.csv( new.pop.table, "MSA_POP.csv", row.names=F )

# sanity check
msa.pop <- unique( select( core1, MSA_NECH, MSA_POP ))
na.omit( msa.pop ) %>% summarize( median(MSA_POP), min(MSA_POP), max(MSA_POP) )





```



## Correct Population Data

```{r}


core.2010 <- readRDS(gzcon(url("https://www.dropbox.com/s/byt7kh3kejg4ycl/nccs.core2010pc.rds?dl=1")))


library(censusapi)

censuskey <- "b431c35dad89e2863681311677d12581e8f24c24"


# 5 year ACS, 2014 - all counties within the US

pop <- getCensus( name="acs5", 
                        vintage=2010, 
                        key=censuskey, 
                        vars=c("B01001_001E"), 
                        region="county:*")

pop$FIPS <- as.numeric( paste0( pop$state, pop$county ))
pop <- rename( pop, COUNTY_POP=B01001_001E )
pop <- select( pop, COUNTY_POP, FIPS)
head( pop )

names( core.2010 ) <- toupper( names( core.2010 ))
core <- select( core.2010, EIN, MSA_NECH, NTMAJ12, FIPS)
core$FIPS <- as.numeric( core$FIPS )

core <- merge( core, pop, by.x="FIPS", by.y="FIPS", all.x=T )

msa.fips.pop <- select( core, MSA_NECH, FIPS, COUNTY_POP ) %>% unique()

msa.pop <- tapply( msa.fips.pop$COUNTY_POP, msa.fips.pop$MSA_NECH, sum, na.rm=T )
msa.pop2 <- data.frame( MSA_NECH=names(msa.pop), MSA_POP=msa.pop )
head( msa.pop2 )
summary( msa.pop2$MSA_POP )

core <- merge( core, msa.pop2, all.x=T )


# write.csv( msa.pop2, "MSA_POP.csv", row.names=F )


```


To get data by MSA (instead of aggregating across counties):

```{r, eval=F}

# MSA

dat  <- getCensus( name="acs5", 
                        vintage=2010, 
                        key=censuskey, 
                        vars=c("B25077_001E"), 
                        region="metropolitan statistical area/micropolitan statistical area:*" )
```



# Create Metrics

calculate at county levels, not MSA, as well

```{r}

pop <- read.csv( "https://www.dropbox.com/s/skg9xn42jqvhzfy/MSA_POP.csv?dl=1", stringsAsFactors=F )

core.2010 <- readRDS(gzcon(url("https://www.dropbox.com/s/byt7kh3kejg4ycl/nccs.core2010pc.rds?dl=1")))

core <- select( core.2010, EIN, MSA_NECH, NTMAJ12, CONT, TOTREV, TOTREV2 )

core <- merge( core, pop, by.x="MSA_NECH", by.y="MSA_NECH", all.x=T )


num.npos.msa <- table( core$MSA_NECH )
num.npos.msa <- as.data.frame( num.npos.msa )
names( num.npos.msa ) <- c("MSA_NECH","N")
num.npos.msa <- merge( num.npos.msa, pop, all.x=T )

npos <- num.npos.msa 
npos$MSA_POP[ npos$MSA_POP <= 0 ] <- NA
per.capita <- npos$N / (npos$MSA_POP/1000)
summary( per.capita )

# sort( per.capita )
# npos$per.capita <- per.capita
# npos[ order( -npos$per.capita ) , ]


hist( per.capita, col="gray", border="white", breaks=50 )




num.npos.msa.ntee <- tapply( core$EIN, INDEX=list(core$MSA_NECH, core$NTMAJ12), length )
t.msa.ntee <- table( core$MSA_NECH, core$NTMAJ12 ) %>% as.data.frame()
names( t.msa.ntee ) <- c( "MSA_NECH", "NTMAJ12", "N")
t.msa.ntee <- merge( t.msa.ntee, pop, all.x=T )




# Contributions per msa

t1 <- table( core$MSA_NECH )
t2 <- tapply( core$CONT, core$MSA_NECH, sum, na.rm=T )

t3 <- as.numeric(t2) / as.numeric( t1 )
summary( t3 )

cont.per.msa <- data.frame( MSA_NECH=names(t1), NPOS=as.numeric(t1), AVE_CONT_PER_NPO=t3, CONT_MSA=t2 )
cont.per.msa <- merge( cont.per.msa, pop )

# average contributions per person in a city
cont.per.capita <- cont.per.msa$CONT_MSA / cont.per.msa$MSA_POP
summary( cont.per.capita )

hist( cont.per.capita, col="gray", border="white", breaks=100, xlim=c(0,5000),
      main="Average Generosity Per Person")


hist( cont.per.msa$AVE_CONT_PER_NPO, col="gray", border="white", breaks=1000, xlim=c(0,2000000),
      main="Mean Tot Contributions Per Nonprofit" )

# compare to $50k in CONT each nonprofit on average:
# summary( core.2010$CONT )
# reason is this is total CONT per MSA / # npos per MSA




cont.per.msa$MSA_POP[ cont.per.msa$MSA_POP <= 0 ] <- NA

contribution.intensity <- cont.per.msa$AVE_CONT_PER_NPO / cont.per.msa$MSA_POP
summary( contribution.intensity )
hist( contribution.intensity, col="gray", border="white", breaks=100,
      main="Average Contributions Per Person Per Nonprofit" )

generosity <- cont.per.msa$CONT_MSA / cont.per.msa$MSA_POP
contribution.intensity <- generosity / cont.per.msa$NPOS
summary( contribution.intensity )
hist( contribution.intensity, col="gray", border="white", breaks=100,
      main="Average Contributions Per Person Per Nonprofit" )


jplot( log10(cont.per.msa$MSA_POP), log10(cont.per.msa$NPOS), 
       xlab="POP per MSA", ylab="Num NPOS (log)", xaxt="n" )
axis( side=1, at=c(5,5.5,6,6.5,7), labels=labs)


jplot( log10(cont.per.msa$MSA_POP), cont.per.msa$NPOS/(cont.per.msa$MSA_POP/1000), 
       xlab="POP per MSA", ylab="NPOs Per Capita", xaxt="n" )
axis( side=1, at=c(5,5.5,6,6.5,7), labels=labs)



labs <- paste0( round( (( 10^seq(5,7,0.5) )/1000),0), "k" )

jplot( contribution.intensity, log(cont.per.msa$AVE_CONT_PER_NPO),
       xlab="Intensity", ylab="Ave CONT Per NPO")




jplot( log10(cont.per.msa$MSA_POP), log10(cont.per.msa$AVE_CONT_PER_NPO), 
       xlab="POP per MSA", ylab="Ave CONT Per NPO (log10)", xaxt="n" )
axis( side=1, at=c(5,5.5,6,6.5,7), labels=labs)


jplot( log10(cont.per.msa$NPOS), log10(cont.per.msa$AVE_CONT_PER_NPO), 
       xlab="Number of NPOs (log10)", ylab="Ave CONT Per NPO (log10)" )

jplot( log10(cont.per.msa$NPOS), contribution.intensity, 
       xlab="Number of NPOs (log10)", ylab="Intensity" )


jplot( cont.per.capita, contribution.intensity, 
       xlab="Generosity", ylab="Intensity", xlim=c(0,2000), ylim=c(0,10) )

jplot( log10(cont.per.msa$MSA_POP), cont.per.capita, 
       xlab="POP per MSA", ylab="Generosity", xaxt="n" )
axis( side=1, at=c(5,5.5,6,6.5,7), labels=labs)

jplot( log10(cont.per.msa$MSA_POP), contribution.intensity, 
       xlab="POP per MSA", ylab="Intensity", xaxt="n" )
axis( side=1, at=c(5,5.5,6,6.5,7), labels=labs)


jplot( log10(cont.per.msa$MSA_POP), cont.per.msa$NPOS/(cont.per.msa$MSA_POP/1000), 
       xlab="POP per MSA", ylab="NPOs Per Capita", xaxt="n" )
axis( side=1, at=c(5,5.5,6,6.5,7), labels=labs)


```



Extra code

```{r}
## where can find better population data; or how to clean the popolation data using R
dat.2010.dplyr <-
core %>% group_by( MSA_NECH, NTMAJ12 ) %>% summarize( n=n(),
                                             total.popu=sum(POPU))


dat.2010.dplyr <-
core %>% group_by( MSA_NECH, NTMAJ12 ) %>% summarize( n=n())


head(dat.2010.dplyr) %>% pander()


```


## Descriptive Statistics


## Reference

Hannan, M. T., & Freeman, J. (1987). The ecology of organizational founding: American labor unions, 1836-1985. American Journal of Sociology, 92(4), 910-943.

Harrison, T., & Thornton, J. (2014, October). Too many nonprofits? An empirical approach to estimating trends in nonprofit demand density. In Nonprofit Policy Forum (Vol. 5, No. 2, pp. 213-229). De Gruyter.

Saxton, G. D., & Benson, M. A. (2005). Social capital and the growth of the nonprofit sector. Social Science Quarterly, 86(1), 16-35.

Paarlberg, L. E., An, S. H., Nesbit, R., Christensen, R. K., & Bullock, J. (2018). A Field Too Crowded? How Measures of Market Structure Shape Nonprofit Fiscal Health. Nonprofit and Voluntary Sector Quarterly, 47(3), 453-473.

LeRoux, K., & Wright, N. S. (2010). Does performance measurement improve strategic decision making? Findings from a national survey of nonprofit social service agencies. Nonprofit and Voluntary Sector Quarterly, 39(4), 571-587.

Lecy, J. D., & Van Slyke, D. M. (2013). Nonprofit sector growth and density: Testing theories of government support. Journal of Public Administration Research and Theory, 23, 189-214.

Castaneda, M. A., Garen, J., & Thornton, J. (2007). Competition, contractibility, and the market for donors to nonprofits. The Journal of Law, Economics, & Organization, 24(1), 215-246.







```{css, echo=F}
p {
color: black;
margin: 0 0 20px 0;
}

td {
    padding: 3px 10px 3px 10px;
    text-align: center;
}

table
{ 
    margin-left: auto;
    margin-right: auto;
    margin-top:80px;
    margin-bottom:100px;
}

h1, h2{
  margin-top:100px;
  margin-bottom:20px;
}

H5{
    text-align: center;
    color: gray;
    font-size:0.8em;
}

img {
    max-width: 90%;
    display: block;
    margin-right: auto;
    margin-left: auto;
    margin-top:30px;
    margin-bottom:20px;
}

pre {
  overflow-x: auto;
}

pre code {
   display: block; 
   padding: 0.5em;
   margin-bottom:20px;
}

code {
  font-size: 92%;
  border: 10px solid #F8F8F8;
  margin-bottom: 2px;
}

code[class] {
  background-color: #F8F8F8;
}

```

